<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>First Principles Derivative — Interactive Widget</title>
  <!-- MathJax for LaTeX rendering -->
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    :root{
      --bg:#0f172a;       /* slate-900 */
      --panel:#111827;    /* gray-900 */
      --muted:#94a3b8;    /* slate-400 */
      --text:#e5e7eb;     /* gray-200 */
      --accent:#22d3ee;   /* cyan-400 */
      --accent2:#a78bfa;  /* violet-400 */
      --ok:#34d399;       /* green-400 */
      --warn:#f59e0b;     /* amber-400 */
      --danger:#f87171;   /* red-400 */
    }
    *{box-sizing:border-box}
    body{
      margin:0; font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      color:var(--text); background:linear-gradient(180deg,#0b1025, var(--bg));
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:16px;
    }
    .app{width: min(1100px, 100%); display:grid; gap:12px;}
    .card{background:rgba(17,24,39,.9); border:1px solid rgba(255,255,255,.06); border-radius:16px; box-shadow:0 8px 30px rgba(0,0,0,.35)}
    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:12px}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
    .header{padding:14px 18px; display:flex; align-items:center; justify-content:space-between; gap:8px}
    .title{font-weight:700; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:14px}
    .controls{padding:14px 18px; display:grid; gap:12px}
    .row{display:grid; grid-template-columns: 170px 1fr 90px; gap:10px; align-items:center}
    .row label{font-weight:600; color:#cbd5e1}
    select, input[type="number"], input[type="text"]{
      width:100%; padding:8px 10px; background:#0b1224; color:var(--text); border:1px solid rgba(255,255,255,.08); border-radius:10px;
    }
    .slider{appearance:none; width:100%; height:8px; background:#0b1224; border:1px solid rgba(255,255,255,.07); border-radius:999px; outline:none}
    .slider::-webkit-slider-thumb{appearance:none; width:18px; height:18px; border-radius:50%; background:var(--accent); border:2px solid #07232d; box-shadow:0 1px 4px rgba(0,0,0,.5)}
    .toggles{display:flex; gap:10px; flex-wrap:wrap}
    .toggle{display:inline-flex; align-items:center; gap:8px; background:#0b1224; border:1px solid rgba(255,255,255,.08); padding:6px 10px; border-radius:999px;}
    .toggle input{accent-color:var(--accent)}
    .btns{display:flex; gap:10px; flex-wrap:wrap}
    .btn{border:1px solid rgba(255,255,255,.12); background:#0b1224; color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600}
    .btn:hover{border-color:rgba(255,255,255,.3)}
    .btn.play{background:linear-gradient(90deg, #0b1224, rgba(34,211,238,.18)); border-color:rgba(34,211,238,.35)}
    .btn.stop{background:linear-gradient(90deg, #0b1224, rgba(248,113,113,.18)); border-color:rgba(248,113,113,.35)}
    .canvas-wrap{position:relative; padding:10px}
    canvas{width:100%; height:520px; display:block; background:
      radial-gradient(800px 300px at 10% 0%, rgba(167,139,250,.1), transparent 40%),
      radial-gradient(800px 300px at 90% 0%, rgba(34,211,238,.08), transparent 42%),
      #0b1224; border-radius:14px}
    .readout{padding:12px 16px; display:grid; gap:6px; border-top:1px solid rgba(255,255,255,.06)}
    .readout .eq{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:14px; color:#c7d2fe}
    .pill{display:inline-flex; align-items:center; gap:8px; background:#081225; border:1px solid rgba(255,255,255,.08); padding:6px 10px; border-radius:999px}
    .legend{display:flex; gap:10px; flex-wrap:wrap}
    .dot{display:inline-block; width:10px; height:10px; border-radius:999px;}
    .dot.fn{background:var(--accent)}
    .dot.sec{background:#f59e0b}
    .dot.tan{background:var(--ok)}
    .note{color:var(--muted); font-size:13px}
    .footer{padding:10px 16px; color:var(--muted); font-size:13px}
    .kbd{background:#111827; border:1px solid rgba(255,255,255,.12); border-bottom-width:2px; padding:.1rem .35rem; border-radius:6px; font-weight:700}
  </style>
</head>
<body>
  <main class="app">
    <section class="card">
      <div class="header">
        <div>
          <div class="title">First Principles of the Derivative — Interactive Demo</div>
          <div class="sub">Visualise the difference quotient <strong>\(\frac{f(x_0+h)-f(x_0)}{h}\)</strong> as <em>h</em> → 0 and see the secant approach the tangent.</div>
        </div>
        <div class="legend">
          <span class="pill"><span class="dot fn"></span> f(x)</span>
          <span class="pill"><span class="dot sec"></span> Secant</span>
          <span class="pill"><span class="dot tan"></span> Tangent (true)</span>
        </div>
      </div>

      <div class="grid">
        <div class="canvas-wrap"><canvas id="plot" width="1200" height="650" aria-label="Function plot with secant and tangent"></canvas></div>
        <div class="controls">
          <div class="row">
            <label for="fnSelect">Function f(x)</label>
            <select id="fnSelect" aria-label="Choose function"></select>
            <div class="note" id="domainNote"></div>
          </div>

          <div class="row">
            <label for="x0">Point x₀</label>
            <input class="slider" type="range" id="x0" min="-5" max="5" step="0.01" />
            <input type="number" id="x0Num" step="0.01" />
          </div>

          <div class="row">
            <label for="h">Step h</label>
            <input class="slider" type="range" id="h" min="-3" max="3" step="0.001" />
            <input type="number" id="hNum" step="0.001" />
          </div>

          <div class="row">
            <label>Difference type</label>
            <div class="toggles" role="group" aria-label="Difference type">
              <label class="toggle"><input type="radio" name="method" value="forward" checked> Forward \(\frac{f(x_0+h)-f(x_0)}{h}\)</label>
              <label class="toggle"><input type="radio" name="method" value="backward"> Backward \(\frac{f(x_0)-f(x_0-h)}{h}\)</label>
              <label class="toggle"><input type="radio" name="method" value="central"> Central \(\frac{f(x_0+h)-f(x_0-h)}{2h}\)</label>
            </div>
            <div></div>
          </div>

          <div class="row">
            <label>Display</label>
            <div class="toggles">
              <label class="toggle"><input type="checkbox" id="showSecant" checked> Show secant</label>
              <label class="toggle"><input type="checkbox" id="showTangent" checked> Show true tangent</label>
              <label class="toggle"><input type="checkbox" id="showGrid" checked> Grid</label>
            </div>
            <div></div>
          </div>

          <div class="btns">
            <button id="play" class="btn play" aria-pressed="false">▶ Animate h → 0</button>
            <button id="resetH" class="btn">Reset h</button>
            <button id="flipH" class="btn">Flip sign of h</button>
          </div>

          <div class="readout" id="readout"></div>
          <div class="footer">Tip: Use <span class="kbd">↑</span>/<span class="kbd">↓</span> to nudge the focused numeric fields. Trig functions use <strong>radians</strong>.</div>
        </div>
      </div>
    </section>
  </main>

<script>
(function(){
  const canvas = document.getElementById('plot');
  const ctx = canvas.getContext('2d');
  const DPR = Math.max(1, window.devicePixelRatio || 1);
  // Scale for crisp rendering on HiDPI
  function resizeCanvas(){
    const cssW = canvas.clientWidth, cssH = canvas.clientHeight;
    canvas.width = Math.round(cssW * DPR);
    canvas.height = Math.round(cssH * DPR);
  }
  resizeCanvas();
  window.addEventListener('resize', ()=>{ resizeCanvas(); draw(); });

  const fnSelect = document.getElementById('fnSelect');
  const x0Slider = document.getElementById('x0');
  const x0Num = document.getElementById('x0Num');
  const hSlider = document.getElementById('h');
  const hNum = document.getElementById('hNum');
  const methodRadios = [...document.querySelectorAll('input[name="method"]')];
  const showSecant = document.getElementById('showSecant');
  const showTangent = document.getElementById('showTangent');
  const showGrid = document.getElementById('showGrid');
  const domainNote = document.getElementById('domainNote');
  const playBtn = document.getElementById('play');
  const resetHBtn = document.getElementById('resetH');
  const flipHBtn = document.getElementById('flipH');
  const readout = document.getElementById('readout');

  // Functions catalogue
  const FNS = {
    x2: {
      label: 'f(x) = x²', f: x=>x*x, df: x=>2*x, domain:[-5,5], hint:'Smooth parabola. f\'(x)=2x.'
    },
    x3mx: {
      label: 'f(x) = x³ − x', f: x=>x*x*x - x, df: x=>3*x*x - 1, domain:[-3,3], hint:'Inflection at x=0.'
    },
    sin: {
      label: 'f(x) = sin x (rad)', f: x=>Math.sin(x), df: x=>Math.cos(x), domain:[-6.28318530718, 6.28318530718], hint:'Derivative is cos x.'
    },
    exp: {
      label: 'f(x) = e^x', f: x=>Math.exp(x), df: x=>Math.exp(x), domain:[-2.5,2.5], hint:'Derivative equals itself.'
    },
    abs: {
      label: 'f(x) = |x| (corner at 0)', f: x=>Math.abs(x), df: null, domain:[-4,4], hint:'Not differentiable at x=0.'
    },
  };

  const state = {
    key: 'x2',
    x0: 1.5,
    h: 1,
    method: 'forward',
    playing: false,
    xMin: -5, xMax: 5, yMin: -5, yMax: 5,
  };

  // Populate select
  for(const [k, v] of Object.entries(FNS)){
    const opt = document.createElement('option');
    opt.value = k; opt.textContent = v.label; fnSelect.appendChild(opt);
  }
  fnSelect.value = state.key;

  function clamp(v, a, b){ return Math.min(b, Math.max(a, v)); }

  function syncControls(){
    x0Slider.min = FNS[state.key].domain[0];
    x0Slider.max = FNS[state.key].domain[1];
    x0Slider.value = state.x0;
    x0Num.value = Number(state.x0.toFixed(3));

    hSlider.value = state.h; hNum.value = Number(state.h.toFixed(4));

    methodRadios.forEach(r=> r.checked = (r.value===state.method));

    domainNote.textContent = `Domain hint: x ∈ [${FNS[state.key].domain[0]}, ${FNS[state.key].domain[1]}]. ${FNS[state.key].hint || ''}`;
  }

  function setKey(k){
    state.key = k;
    const d = FNS[k].domain;
    // Keep x0 within domain
    state.x0 = clamp(state.x0, d[0]+0.001, d[1]-0.001);
    // Reset view window around domain
    state.xMin = d[0]; state.xMax = d[1];
    autoScaleY();
    syncControls();
    draw();
  }

  function fx(x){ return FNS[state.key].f(x); }
  function dfx(x){ return FNS[state.key].df ? FNS[state.key].df(x) : NaN; }

  function autoScaleY(){
    // sample function over x-range to estimate y extents
    let yMin=Infinity, yMax=-Infinity;
    const N=400; const dx=(state.xMax-state.xMin)/(N-1);
    for(let i=0;i<N;i++){
      const x = state.xMin + i*dx;
      const y = fx(x);
      if (!Number.isFinite(y)) continue;
      if (y<yMin) yMin=y; if (y>yMax) yMax=y;
    }
    if (!Number.isFinite(yMin) || !Number.isFinite(yMax) || yMin===yMax){ yMin=-1; yMax=1; }
    const pad = (yMax-yMin)*0.2 + 1e-6;
    state.yMin = yMin - pad; state.yMax = yMax + pad;
  }

  // Coordinate transforms
  function X(x){ return (x - state.xMin) / (state.xMax - state.xMin) * canvas.width; }
  function Y(y){ return (1 - (y - state.yMin) / (state.yMax - state.yMin)) * canvas.height; }

  function drawGrid(){
    if(!showGrid.checked) return;
    ctx.save();
    ctx.lineWidth = 1 * DPR;
    // background grid
    ctx.strokeStyle = 'rgba(255,255,255,0.05)';
    const xStep = niceStep((state.xMax-state.xMin)/10);
    const yStep = niceStep((state.yMax-state.yMin)/10);
    for(let x = Math.ceil(state.xMin/xStep)*xStep; x<=state.xMax; x+=xStep){
      const Xx = X(x);
      ctx.beginPath(); ctx.moveTo(Xx, 0); ctx.lineTo(Xx, canvas.height); ctx.stroke();
    }
    for(let y = Math.ceil(state.yMin/yStep)*yStep; y<=state.yMax; y+=yStep){
      const Yy = Y(y);
      ctx.beginPath(); ctx.moveTo(0, Yy); ctx.lineTo(canvas.width, Yy); ctx.stroke();
    }
    // axes
    ctx.strokeStyle = 'rgba(255,255,255,0.35)';
    // y=0
    if(state.yMin < 0 && state.yMax > 0){
      ctx.beginPath(); ctx.moveTo(0, Y(0)); ctx.lineTo(canvas.width, Y(0)); ctx.stroke();
    }
    // x=0
    if(state.xMin < 0 && state.xMax > 0){
      ctx.beginPath(); ctx.moveTo(X(0), 0); ctx.lineTo(X(0), canvas.height); ctx.stroke();
    }
    ctx.restore();
  }

  function niceStep(delta){
    const raw = delta;
    const pow = Math.pow(10, Math.floor(Math.log10(raw)));
    const n = raw / pow;
    const steps = [1,2,2.5,5,10];
    const s = steps.find(v => n <= v) || 10;
    return s * pow;
  }

  function plotFunction(){
    ctx.save();
    ctx.strokeStyle = '#22d3ee';
    ctx.lineWidth = 2.2 * DPR;
    ctx.beginPath();
    const N = canvas.width; // one pixel per sample
    for(let i=0;i<N;i++){
      const x = state.xMin + (i / (N-1)) * (state.xMax - state.xMin);
      const y = fx(x);
      if(i===0) ctx.moveTo(i, Y(y)); else ctx.lineTo(i, Y(y));
    }
    ctx.stroke();
    ctx.restore();
  }

  function drawPoint(x, y, color){
    ctx.save();
    ctx.fillStyle = color; ctx.strokeStyle = 'rgba(0,0,0,.6)';
    const r = 6 * DPR;
    ctx.beginPath(); ctx.arc(X(x), Y(y), r, 0, Math.PI*2); ctx.fill();
    ctx.lineWidth = 2 * DPR; ctx.stroke();
    ctx.restore();
  }

  function drawLineThroughPointSlope(x, y, m, color){
    if(!Number.isFinite(m)) return;
    const y1 = y + m*(state.xMin - x);
    const y2 = y + m*(state.xMax - x);
    ctx.save();
    ctx.strokeStyle = color; ctx.lineWidth = 2 * DPR;
    ctx.setLineDash([8 * DPR, 8 * DPR]);
    ctx.beginPath(); ctx.moveTo(X(state.xMin), Y(y1)); ctx.lineTo(X(state.xMax), Y(y2)); ctx.stroke();
    ctx.restore();
  }

  function drawSecant(x0, h, method){
    let xA, yA, xB, yB;
    if(method==='forward'){ xA = x0; yA = fx(xA); xB = x0 + h; yB = fx(xB); }
    else if(method==='backward'){ xA = x0 - h; yA = fx(xA); xB = x0; yB = fx(xB); }
    else { xA = x0 - h; yA = fx(xA); xB = x0 + h; yB = fx(xB); }

    const m = (yB - yA) / ( (method==='central') ? (2*h) : (xB - xA) );

    if(showSecant.checked && Number.isFinite(m)){
      // draw secant dashed
      drawLineThroughPointSlope(xA, yA, m, '#f59e0b');
    }
    // points
    drawPoint(xA, yA, '#f59e0b');
    drawPoint(xB, yB, '#f59e0b');

    return {m, xA, yA, xB, yB};
  }

  function drawTangent(x0){
    const m = dfx(x0);
    if(Number.isFinite(m) && showTangent.checked){
      drawLineThroughPointSlope(x0, fx(x0), m, '#34d399');
    }
    return m;
  }

  function format(n, digits=6){
    if(!Number.isFinite(n)) return '—';
    return (+n).toFixed(digits);
  }

  async function typeset(el){
    if(window.MathJax && MathJax.typesetPromise){
      try{ await MathJax.typesetPromise([el]); }catch(e){}
    }
  }

  async function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawGrid();
    plotFunction();
    const sec = drawSecant(state.x0, state.h, state.method);
    const tanM = drawTangent(state.x0);

    const f_x0 = fx(state.x0);
    let dq, formula;
    if(state.method==='forward'){
      dq = (fx(state.x0 + state.h) - f_x0) / state.h;
      formula = `\\frac{f(x_0+h)-f(x_0)}{h}`;
    } else if(state.method==='backward'){
      dq = (f_x0 - fx(state.x0 - state.h)) / state.h;
      formula = `\\frac{f(x_0)-f(x_0-h)}{h}`;
    } else {
      dq = (fx(state.x_0 + state.h) - fx(state.x_0 - state.h)) / (2*state.h);
      // Fix: x_0 typos replaced below
      dq = (fx(state.x0 + state.h) - fx(state.x0 - state.h)) / (2*state.h);
      formula = `\\frac{f(x_0+h)-f(x_0-h)}{2h}`;
    }

    // Readout
    const err = Number.isFinite(tanM) && Number.isFinite(dq) ? Math.abs(dq - tanM) : NaN;
    const html = `
      <div class="eq">First principles at x₀=${format(state.x0,3)}: &nbsp; \\( f'(x_0) = \\lim_{h\\to 0} ${formula} \\)</div>
      <div class="legend">
        <span class="pill">x₀ = <strong>${format(state.x0,3)}</strong></span>
        <span class="pill">h = <strong>${format(state.h,4)}</strong></span>
        <span class="pill">f(x₀) = <strong>${format(f_x0,6)}</strong></span>
        <span class="pill">Difference quotient ≈ <strong>${format(dq,6)}</strong></span>
        <span class="pill">True f'(x₀) = <strong>${Number.isFinite(tanM)?format(tanM,6):'—'}</strong></span>
        <span class="pill">Error = <strong style="color:${!Number.isFinite(err)?'var(--muted)':(err<1e-3?'var(--ok)':(err<1e-1?'var(--warn)':'var(--danger)'))}">${Number.isFinite(err)?format(err,6):'—'}</strong></span>
      </div>
      <div class="note">${FNS[state.key].df ? 'Analytic derivative shown in green.' : 'Analytic derivative not available for this function; try others.'}</div>
    `;
    readout.innerHTML = html;
    await typeset(readout);
  }

  // Interaction wiring
  fnSelect.addEventListener('change', (e)=> setKey(e.target.value));

  function setX0(v){
    const d = FNS[state.key].domain;
    state.x0 = clamp(+v, d[0]+1e-6, d[1]-1e-6);
    x0Slider.value = state.x0; x0Num.value = Number(state.x0.toFixed(3));
    draw();
  }
  function setH(v){
    let h = +v; if (Math.abs(h) < 1e-8) h = (h>=0?1:-1)*1e-8; // avoid exactly zero
    state.h = clamp(h, +hSlider.min, +hSlider.max);
    hSlider.value = state.h; hNum.value = Number(state.h.toFixed(4));
    draw();
  }

  x0Slider.addEventListener('input', e=> setX0(e.target.value));
  x0Num.addEventListener('input', e=> setX0(e.target.value));
  hSlider.addEventListener('input', e=> setH(e.target.value));
  hNum.addEventListener('input', e=> setH(e.target.value));

  methodRadios.forEach(r=> r.addEventListener('change', e=>{ if(e.target.checked){ state.method = e.target.value; draw(); }}));

  showSecant.addEventListener('change', draw);
  showTangent.addEventListener('change', draw);
  showGrid.addEventListener('change', draw);

  // Animation: shrink |h| toward zero
  let timer=null;
  function stepAnim(){
    const s = Math.sign(state.h) || 1;
    const next = Math.abs(state.h)*0.7; // decay factor
    const min = 1e-4;
    if(next < min){ stopAnim(); return; }
    setH(s*next);
  }
  function startAnim(){
    if(timer) return; state.playing=true; playBtn.classList.remove('play'); playBtn.classList.add('stop'); playBtn.textContent='⏸ Pause'; playBtn.setAttribute('aria-pressed','true');
    timer = setInterval(stepAnim, 250);
  }
  function pauseAnim(){
    if(!timer) return; clearInterval(timer); timer=null; state.playing=false; playBtn.classList.remove('stop'); playBtn.classList.add('play'); playBtn.textContent='▶ Animate h → 0'; playBtn.setAttribute('aria-pressed','false');
  }
  function stopAnim(){ pauseAnim(); }

  playBtn.addEventListener('click', ()=>{
    if(state.playing) pauseAnim(); else startAnim();
  });
  resetHBtn.addEventListener('click', ()=>{ setH(1); pauseAnim(); });
  flipHBtn.addEventListener('click', ()=>{ setH(-state.h); });

  // Init
  setKey(state.key);
  setX0(state.x0);
  setH(state.h);
})();
</script>
</body>
</html>
