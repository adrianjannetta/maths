<div style="border:2px solid #1e5aa8; border-radius:12px; padding:14px; max-width:1200px; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;">
  <h2 style="margin:0 0 6px 0; color:#1e5aa8;">Water Phase Diagram + Heating Curve Explorer</h2>
  <div style="font-size:13px; color:#234; line-height:1.35; margin-bottom:10px;">
    Controls are at the top. The <b>phase diagram</b> and <b>heating curve</b> are side-by-side below (responsive).
  </div>

  <!-- CONTROLS (TOP ROW) -->
  <div style="
    border:1px solid #cfe2ff;
    background:#f3f8ff;
    border-radius:12px;
    padding:12px;
    display:flex;
    gap:14px;
    flex-wrap:wrap;
    align-items:flex-end;
  ">
    <!-- Pressure -->
    <div style="flex: 1 1 260px; min-width:240px;">
      <div style="font-size:13px; color:#123; margin-bottom:6px;"><b>Pressure</b></div>
      <input id="Pslider" type="range" min="-5" max="6" step="0.01" value="0" style="width:100%;">
      <div style="display:flex; justify-content:space-between; font-size:12px; color:#456; margin-top:2px;">
        <span>10⁻⁵ bar</span><span>10⁶ bar</span>
      </div>
      <div style="font-size:12px; color:#567; margin-top:4px;">
        log₁₀(P/bar) = <b><span id="logPout">0.00</span></b> &nbsp;→&nbsp; P = <b><span id="Pout">1.00</span> bar</b>
      </div>
    </div>

    <!-- Start temperature -->
    <div style="flex: 1 1 240px; min-width:220px;">
      <div style="font-size:13px; color:#123; margin-bottom:6px;"><b>Start temperature</b></div>
      <input id="Tstart" type="range" min="-150" max="300" step="1" value="-20" style="width:100%;">
      <div style="display:flex; justify-content:space-between; font-size:12px; color:#456; margin-top:2px;">
        <span>-150°C</span><span>300°C</span>
      </div>
      <div style="font-size:12px; color:#567; margin-top:4px;">
        Start T = <b><span id="TstartOut">-20</span> °C</b>
      </div>
    </div>

    <!-- Mass -->
    <div style="flex: 0 0 150px; min-width:150px;">
      <div style="font-size:13px; color:#123; margin-bottom:6px;"><b>Mass</b></div>
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="mass" type="number" min="0.05" max="10" step="0.05" value="1"
               style="width:90px; padding:6px; border:1px solid #ccd; border-radius:8px;">
        <span style="font-size:13px; color:#234;">kg</span>
      </div>
      <div style="font-size:12px; color:#567; margin-top:6px;">
        Tₘ ≈ <b><span id="TmOut">0.0</span> °C</b><br>
        Tᵦ ≈ <b><span id="TbOut">100.0</span> °C</b>
      </div>
    </div>

    <!-- Heat added -->
    <div style="flex: 1 1 280px; min-width:260px;">
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:baseline; margin-bottom:6px;">
        <div style="font-size:13px; color:#123;"><b>Heat added</b></div>
        <div style="font-size:12px; color:#456;">Q = <b><span id="Qout">0</span> kJ</b></div>
      </div>
      <input id="Qslider" type="range" min="0" max="3500" step="1" value="0" style="width:100%;">
      <div style="display:flex; justify-content:space-between; font-size:12px; color:#456; margin-top:2px;">
        <span>0</span><span id="QmaxLabel">3500 kJ</span>
      </div>
      <div style="font-size:12px; color:#567; margin-top:4px;">
        Current T = <b><span id="TnowOut">-20.0</span> °C</b> &nbsp;•&nbsp;
        <b><span id="stateOut" style="color:#0b8a3b;">Ice warming</span></b>
      </div>
    </div>

    <!-- Quick set -->
    <div style="flex: 0 0 auto;">
      <div style="font-size:13px; color:#123; margin-bottom:6px;"><b>Quick set</b></div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn" data-preset="sea">1 bar</button>
        <button class="btn" data-preset="mountain">0.7 bar</button>
        <button class="btn" data-preset="pressurecooker">15 bar</button>
        <button class="btn" data-preset="deep">10⁴ bar</button>
        <button class="btn" data-preset="verydeep">10⁶ bar</button>
      </div>
    </div>
  </div>

  <!-- PLOTS (SIDE-BY-SIDE) -->
  <div style="display:flex; gap:12px; margin-top:12px; flex-wrap:wrap;">
    <div style="flex:1 1 520px; min-width:320px;">
      <div style="font-size:12px; color:#456; margin:0 0 6px 2px;"><b>Phase diagram</b> (T from −150°C to 450°C, P from 10⁻⁵ to 10⁶ bar)</div>
      <canvas id="phaseCanvas" width="640" height="420"
              style="width:100%; height:auto; border-radius:12px; border:1px solid #cdd; background:white;"></canvas>
    </div>

    <div style="flex:1 1 520px; min-width:320px;">
      <div style="font-size:12px; color:#456; margin:0 0 6px 2px;"><b>Heating curve</b> (T vs Q at the chosen pressure)</div>
      <canvas id="heatCanvas" width="640" height="420"
              style="width:100%; height:auto; border-radius:12px; border:1px solid #cdd; background:white;"></canvas>
    </div>
  </div>

  <div style="margin-top:10px; font-size:12px; color:#567;">
    Note: phase boundaries are approximate (teaching model). At very high pressures, real water has multiple solid phases.
  </div>
</div>

<script>
(() => {
  // ---------- Helpers ----------
  const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
  const log10 = (x)=>Math.log(x)/Math.LN10;

  // ---------- Phase-curve approximations (teaching model) ----------
  function Psat_bar(Tc){
    // Antoine (blended) – good for intuition, not precision.
    const A1=8.07131, B1=1730.63, C1=233.426;
    const A2=8.14019, B2=1810.94, C2=244.485;
    let w=0;
    if (Tc<=90) w=0;
    else if (Tc>=110) w=1;
    else w=(Tc-90)/20;
    const logP1 = A1 - (B1/(C1+Tc));
    const logP2 = A2 - (B2/(C2+Tc));
    const logPmmHg = (1-w)*logP1 + w*logP2;
    const Pbar = (Math.pow(10,logPmmHg)/760)*1.01325;
    return clamp(Pbar,1e-12,1e9);
  }

  function invertPsatForT(Pbar){
    let lo=-150, hi=450;
    for (let i=0;i<55;i++){
      const mid=0.5*(lo+hi);
      const pm=Psat_bar(mid);
      if (pm<Pbar) lo=mid; else hi=mid;
    }
    return 0.5*(lo+hi);
  }

  function Psub_bar(Tc){
    const Tk=Tc+273.15;
    const a=6.74, b=-2350;
    const logP=a + b/Tk;
    return clamp(Math.pow(10,logP),1e-12,0.05);
  }

  function Tmelt_C(Pbar){
    // Simplified negative slope near 0°C (exaggerated for visibility)
    const k=0.007;
    return 0 - k*(Pbar-1);
  }

  const TRIPLE={T:0.01,P:0.0061};
  const CRIT={T:374,P:221};

  function phaseOf(Tc,Pbar){
    if (Tc>=CRIT.T && Pbar>=CRIT.P) return "Supercritical fluid";
    if (Tc<TRIPLE.T && Pbar<TRIPLE.P){
      const Psub=Psub_bar(Tc);
      return (Pbar>=Psub) ? "Solid (ice)" : "Vapour";
    }
    const Tm=Tmelt_C(Pbar);
    if (Tc<=Tm && Pbar>=TRIPLE.P) return "Solid (ice)";
    const Ps=Psat_bar(Tc);
    return (Pbar>=Ps) ? "Liquid" : "Vapour";
  }

  // ---------- Heating curve model ----------
  const c_ice=2.1, c_liq=4.18, c_steam=2.0; // kJ/kg/K
  const Lf=334, Lv=2256; // kJ/kg

  function buildHeatingSegments(Pbar, TstartC, mkg){
    const Tm = Tmelt_C(Pbar);
    const Tb = invertPsatForT(Pbar);
    const normal = (Pbar >= TRIPLE.P);

    const segs = [];
    let Q=0, T=TstartC;
    const push = (Q0,Q1,T0,T1,label)=>segs.push({Q0,Q1,T0,T1,label});

    if (!normal){
      const Ttp = TRIPLE.T;
      if (T < Ttp){
        const dQ = mkg*c_ice*(Ttp - T);
        push(Q,Q+dQ,T,Ttp,"Ice warming");
        Q+=dQ; T=Ttp;
      }
      const dQ2 = mkg*(Lf+Lv)*0.6;
      push(Q,Q+dQ2,Ttp,Ttp,"Sublimation / phase change");
      Q+=dQ2;
      const Tend=250;
      const dQ3 = mkg*c_steam*(Tend - Ttp);
      push(Q,Q+dQ3,Ttp,Tend,"Vapour warming");
      Q+=dQ3;
      return {segs, Tm:Ttp, Tb:Tb, Qmax:Q};
    }

    if (T < Tm){
      const dQ = mkg*c_ice*(Tm - T);
      push(Q,Q+dQ,T,Tm,"Ice warming");
      Q+=dQ; T=Tm;
    }
    if (T <= Tm + 1e-9){
      const dQ = mkg*Lf;
      push(Q,Q+dQ,Tm,Tm,"Melting (latent heat)");
      Q+=dQ; T=Tm;
    }
    if (T < Tb){
      const dQ = mkg*c_liq*(Tb - T);
      push(Q,Q+dQ,T,Tb,"Liquid warming");
      Q+=dQ; T=Tb;
    }
    if (Tb < CRIT.T && Pbar < CRIT.P){
      const dQ = mkg*Lv;
      push(Q,Q+dQ,Tb,Tb,"Boiling (latent heat)");
      Q+=dQ;
    }
    const Tend = (Pbar >= CRIT.P) ? 450 : 350;
    const dQ = mkg*c_steam*(Tend - Tb);
    push(Q,Q+dQ,Tb,Tend,(Pbar >= CRIT.P) ? "Supercritical warming" : "Steam warming");
    Q+=dQ;

    return {segs, Tm, Tb, Qmax:Q};
  }

  function TfromQ(segs, Q){
    for (const s of segs){
      if (Q >= s.Q0 && Q <= s.Q1){
        if (Math.abs(s.T1 - s.T0) < 1e-9) return {T:s.T0, label:s.label};
        const f=(Q-s.Q0)/(s.Q1-s.Q0);
        return {T:s.T0 + f*(s.T1-s.T0), label:s.label};
      }
    }
    const last=segs[segs.length-1];
    return {T:last.T1, label:last.label};
  }

  // ---------- Generic axes ----------
  function drawAxes(ctx, W, H, M, xLabel, yLabel, xTicks, yTicks){
    ctx.clearRect(0,0,W,H);

    // grid
    ctx.save();
    ctx.strokeStyle="#e7eef9";
    ctx.lineWidth=1;
    xTicks.forEach(t=>{
      ctx.beginPath(); ctx.moveTo(t.x, M.t); ctx.lineTo(t.x, H-M.b); ctx.stroke();
    });
    yTicks.forEach(t=>{
      ctx.beginPath(); ctx.moveTo(M.l, t.y); ctx.lineTo(W-M.r, t.y); ctx.stroke();
    });
    ctx.restore();

    // axes
    ctx.save();
    ctx.strokeStyle="#234";
    ctx.lineWidth=1.5;
    ctx.beginPath(); ctx.moveTo(M.l,H-M.b); ctx.lineTo(W-M.r,H-M.b); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(M.l,M.t); ctx.lineTo(M.l,H-M.b); ctx.stroke();
    ctx.restore();

    // tick labels
    ctx.fillStyle="#234";
    ctx.font="12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    xTicks.forEach(t=>{
      ctx.strokeStyle="#234"; ctx.lineWidth=1;
      ctx.beginPath(); ctx.moveTo(t.x,H-M.b); ctx.lineTo(t.x,H-M.b+6); ctx.stroke();
      ctx.fillText(t.label, t.x-14, H-M.b+22);
    });
    yTicks.forEach(t=>{
      ctx.strokeStyle="#234"; ctx.lineWidth=1;
      ctx.beginPath(); ctx.moveTo(M.l-6,t.y); ctx.lineTo(M.l,t.y); ctx.stroke();
      ctx.fillText(t.label, 10, t.y+4);
    });

    // axis labels
    ctx.fillText(xLabel, (M.l+W-M.r)/2 - ctx.measureText(xLabel).width/2, H-18);
    ctx.save();
    ctx.translate(16,(M.t+H-M.b)/2 + ctx.measureText(yLabel).width/2);
    ctx.rotate(-Math.PI/2);
    ctx.fillText(yLabel, 0, 0);
    ctx.restore();
  }

  // ---------- Phase diagram ----------
  const phaseCanvas=document.getElementById("phaseCanvas");
  const pctx=phaseCanvas.getContext("2d");
  const pW=phaseCanvas.width, pH=phaseCanvas.height;
  const pM={l:70,r:16,t:18,b:52};

  const Tmin=-150, Tmax=450;
  const lpMin=-5, lpMax=6;

  const xOfT = (T)=>pM.l + (T-Tmin)*(pW-pM.l-pM.r)/(Tmax-Tmin);
  const yOfLP = (lp)=>pH-pM.b - (lp-lpMin)*(pH-pM.t-pM.b)/(lpMax-lpMin);

  function sampleCurve(fnPbar, T0, T1, step){
    const pts=[];
    for (let T=T0; T<=T1+1e-9; T+=step){
      const P=fnPbar(T);
      const lp=log10(P);
      if (!isFinite(lp)) continue;
      pts.push({T, lp});
    }
    return pts;
  }

  function drawPhaseDiagram(Tc, Pbar){
    // ticks
    const xTicks=[];
    for (let T=-150; T<=450; T+=150) xTicks.push({x:xOfT(T), label:String(T)});
    const yTicks=[];
    for (let lp=-5; lp<=6; lp+=1) yTicks.push({y:yOfLP(lp), label:(lp%2===0? String(lp):"")});

    drawAxes(pctx,pW,pH,pM,"Temperature (°C)","log₁₀(P/bar)",xTicks,yTicks);

    // curves
    const subPts  = sampleCurve(Psub_bar, Tmin, TRIPLE.T, 1);
    const boilPts = sampleCurve(Psat_bar, TRIPLE.T, Tmax, 1);
    const meltPts=[];
    for (let lp=lpMin; lp<=lpMax; lp+=0.03){
      const P=Math.pow(10,lp);
      meltPts.push({T: Tmelt_C(P), lp});
    }

    // --- shading (clear regions) ---
    // vapour (below sublimation + below boiling)
    pctx.save();
    pctx.globalAlpha=0.12;
    pctx.fillStyle="#1e5aa8";
    // vapour left side
    pctx.beginPath();
    pctx.moveTo(xOfT(Tmin), yOfLP(lpMin));
    for (const pt of subPts) pctx.lineTo(xOfT(pt.T), yOfLP(clamp(pt.lp, lpMin, lpMax)));
    pctx.lineTo(xOfT(TRIPLE.T), yOfLP(lpMin));
    pctx.closePath();
    pctx.fill();
    // vapour right side
    pctx.beginPath();
    pctx.moveTo(xOfT(TRIPLE.T), yOfLP(lpMin));
    for (const pt of boilPts) pctx.lineTo(xOfT(pt.T), yOfLP(clamp(pt.lp, lpMin, lpMax)));
    pctx.lineTo(xOfT(Tmax), yOfLP(lpMin));
    pctx.closePath();
    pctx.fill();
    pctx.restore();

    // liquid (above boiling)
    pctx.save();
    pctx.globalAlpha=0.10;
    pctx.fillStyle="#0b8a3b";
    pctx.beginPath();
    pctx.moveTo(xOfT(TRIPLE.T), yOfLP(lpMax));
    for (const pt of boilPts) pctx.lineTo(xOfT(pt.T), yOfLP(clamp(pt.lp, lpMin, lpMax)));
    pctx.lineTo(xOfT(Tmax), yOfLP(lpMax));
    pctx.closePath();
    pctx.fill();
    pctx.restore();

    // solid (above sublimation + stylised left-of-melt region)
    pctx.save();
    pctx.globalAlpha=0.12;
    pctx.fillStyle="#666";
    // above sublimation
    pctx.beginPath();
    pctx.moveTo(xOfT(Tmin), yOfLP(lpMax));
    pctx.lineTo(xOfT(Tmin), yOfLP(lpMin));
    for (const pt of subPts) pctx.lineTo(xOfT(pt.T), yOfLP(clamp(pt.lp, lpMin, lpMax)));
    pctx.lineTo(xOfT(TRIPLE.T), yOfLP(lpMax));
    pctx.closePath();
    pctx.fill();
    // left of melting line (stylised)
    pctx.beginPath();
    pctx.moveTo(xOfT(Tmin), yOfLP(lpMax));
    pctx.lineTo(xOfT(Tmin), yOfLP(lpMin));
    for (const pt of meltPts) pctx.lineTo(xOfT(clamp(pt.T, Tmin, Tmax)), yOfLP(clamp(pt.lp, lpMin, lpMax)));
    pctx.lineTo(xOfT(Tmin), yOfLP(lpMax));
    pctx.closePath();
    pctx.fill();
    pctx.restore();

    // supercritical
    pctx.save();
    pctx.globalAlpha=0.10;
    pctx.fillStyle="#b22";
    const xCrit=xOfT(CRIT.T), yCrit=yOfLP(log10(CRIT.P));
    pctx.beginPath();
    pctx.moveTo(xCrit, yCrit);
    pctx.lineTo(xOfT(Tmax), yCrit);
    pctx.lineTo(xOfT(Tmax), yOfLP(lpMax));
    pctx.lineTo(xCrit, yOfLP(lpMax));
    pctx.closePath();
    pctx.fill();
    pctx.restore();

    // --- boundaries (thick) ---
    function drawPts(pts, stroke, width){
      pctx.save();
      pctx.strokeStyle=stroke; pctx.lineWidth=width;
      pctx.beginPath();
      let first=true;
      for (const pt of pts){
        const x=xOfT(pt.T), y=yOfLP(clamp(pt.lp, lpMin, lpMax));
        if (first){pctx.moveTo(x,y); first=false;} else pctx.lineTo(x,y);
      }
      pctx.stroke();
      pctx.restore();
    }
    drawPts(subPts,  "#444", 3);
    drawPts(boilPts, "#1e5aa8", 3);

    pctx.save();
    pctx.strokeStyle="#2f8f2f"; pctx.lineWidth=3;
    pctx.beginPath();
    let first=true;
    for (const pt of meltPts){
      const x=xOfT(clamp(pt.T, Tmin, Tmax));
      const y=yOfLP(clamp(pt.lp, lpMin, lpMax));
      if (first){pctx.moveTo(x,y); first=false;} else pctx.lineTo(x,y);
    }
    pctx.stroke();
    pctx.restore();

    // key points
    function keyPoint(pt, label){
      const x=xOfT(pt.T), y=yOfLP(log10(pt.P));
      pctx.fillStyle="#b22";
      pctx.beginPath(); pctx.arc(x,y,4,0,Math.PI*2); pctx.fill();
      pctx.fillStyle="#234";
      pctx.font="12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      pctx.fillText(label, x+8, y-6);
    }
    keyPoint(TRIPLE,"Triple");
    keyPoint(CRIT,"Critical");

    // region labels
    pctx.save();
    pctx.font="bold 15px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    pctx.fillStyle="rgba(30,90,168,0.80)";
    pctx.fillText("VAPOUR", xOfT(220), yOfLP(-2.8));
    pctx.fillStyle="rgba(11,138,59,0.80)";
    pctx.fillText("LIQUID", xOfT(40), yOfLP(1.0));
    pctx.fillStyle="rgba(80,80,80,0.80)";
    pctx.fillText("SOLID", xOfT(-120), yOfLP(2.7));
    pctx.fillStyle="rgba(178,34,34,0.80)";
    pctx.fillText("SUPERCRITICAL", xOfT(280), yOfLP(5.4));
    pctx.restore();

    // state point
    const x=xOfT(Tc), y=yOfLP(log10(Pbar));
    pctx.fillStyle="#111";
    pctx.beginPath(); pctx.arc(x,y,6,0,Math.PI*2); pctx.fill();
    pctx.strokeStyle="#fff"; pctx.lineWidth=2;
    pctx.beginPath(); pctx.arc(x,y,6,0,Math.PI*2); pctx.stroke();
  }

  // ---------- Heating curve ----------
  const heatCanvas=document.getElementById("heatCanvas");
  const hctx=heatCanvas.getContext("2d");
  const hW=heatCanvas.width, hH=heatCanvas.height;
  const hM={l:70,r:16,t:18,b:52};

  function drawHeatingCurve(segs, Qnow, Tnow, Tm, Tb, Qmax){
    const Qmin=0, QmaxPlot=Qmax;

    let TminPlot = Math.min(-150, ...segs.map(s=>Math.min(s.T0,s.T1))) - 10;
    let TmaxPlot = Math.max(250, ...segs.map(s=>Math.max(s.T0,s.T1))) + 10;
    TminPlot = clamp(TminPlot, -170, 80);
    TmaxPlot = clamp(TmaxPlot, 120, 470);

    const xOfQ=(Q)=>hM.l + (Q-Qmin)*(hW-hM.l-hM.r)/(QmaxPlot-Qmin);
    const yOfT=(T)=>hH-hM.b - (T-TminPlot)*(hH-hM.t-hM.b)/(TmaxPlot-TminPlot);

    const xTicks=[];
    for (let i=0;i<=5;i++){
      const q=Qmin + (QmaxPlot-Qmin)*i/5;
      xTicks.push({x:xOfQ(q), label:String(Math.round(q))});
    }
    const yTicks=[];
    for (let T=Math.ceil(TminPlot/100)*100; T<=TmaxPlot; T+=100){
      yTicks.push({y:yOfT(T), label:String(T)});
    }

    drawAxes(hctx,hW,hH,hM,"Heat added Q (kJ)","Temperature (°C)",xTicks,yTicks);

    // curve
    hctx.save();
    hctx.strokeStyle="#111";
    hctx.lineWidth=2.5;
    hctx.beginPath();
    let first=true;
    for (const s of segs){
      const x0=xOfQ(s.Q0), y0=yOfT(s.T0);
      const x1=xOfQ(s.Q1), y1=yOfT(s.T1);
      if (first){hctx.moveTo(x0,y0); first=false;}
      hctx.lineTo(x1,y1);
    }
    hctx.stroke();
    hctx.restore();

    // dashed lines and labels: Tₘ and Tᵦ
    function hLine(T, label){
      const y=yOfT(T);
      hctx.save();
      hctx.strokeStyle="#b22";
      hctx.setLineDash([6,5]);
      hctx.beginPath(); hctx.moveTo(hM.l,y); hctx.lineTo(hW-hM.r,y); hctx.stroke();
      hctx.setLineDash([]);
      hctx.fillStyle="#234";
      hctx.font="12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      hctx.fillText(label, hM.l+8, y-6);
      hctx.restore();
    }
    hLine(Tm, "Tₘ");
    hLine(Tb, "Tᵦ");

    // current point
    const x=xOfQ(Qnow), y=yOfT(Tnow);
    hctx.fillStyle="#1e5aa8";
    hctx.beginPath(); hctx.arc(x,y,6,0,Math.PI*2); hctx.fill();
    hctx.strokeStyle="#fff"; hctx.lineWidth=2;
    hctx.beginPath(); hctx.arc(x,y,6,0,Math.PI*2); hctx.stroke();
  }

  // ---------- UI wiring ----------
  const Pslider=document.getElementById("Pslider");
  const Tstart=document.getElementById("Tstart");
  const mass=document.getElementById("mass");
  const Qslider=document.getElementById("Qslider");

  const Pout=document.getElementById("Pout");
  const logPout=document.getElementById("logPout");
  const TstartOut=document.getElementById("TstartOut");
  const Qout=document.getElementById("Qout");
  const stateOut=document.getElementById("stateOut");
  const TnowOut=document.getElementById("TnowOut");
  const TmOut=document.getElementById("TmOut");
  const TbOut=document.getElementById("TbOut");
  const QmaxLabel=document.getElementById("QmaxLabel");

  function styleButtons(){
    document.querySelectorAll(".btn").forEach(btn=>{
      btn.style.padding="7px 10px";
      btn.style.borderRadius="10px";
      btn.style.border="1px solid #ccd";
      btn.style.background="#fff";
      btn.style.cursor="pointer";
      btn.addEventListener("mouseenter",()=>btn.style.background="#f2f7ff");
      btn.addEventListener("mouseleave",()=>btn.style.background="#fff");
    });
  }

  function formatP(Pbar){
    if (Pbar < 0.1) return Pbar.toExponential(2);
    if (Pbar < 1000) return Pbar.toFixed(2);
    return Pbar.toExponential(2);
  }

  function updateAll(){
    const logP=parseFloat(Pslider.value);
    const Pbar=Math.pow(10,logP);
    const T0=parseFloat(Tstart.value);
    const mkg=clamp(parseFloat(mass.value||1),0.05,10);

    const {segs, Tm, Tb, Qmax} = buildHeatingSegments(Pbar, T0, mkg);

    // dynamic Q slider range
    const QmaxRounded = Math.max(200, Math.ceil(Qmax/50)*50);
    Qslider.max = QmaxRounded;
    QmaxLabel.textContent = `${QmaxRounded} kJ`;

    const Qnow = clamp(parseFloat(Qslider.value), 0, QmaxRounded);
    Qslider.value = Qnow;

    const {T: Tnow, label} = TfromQ(segs, Qnow);
    const ph = phaseOf(Tnow, Pbar);

    logPout.textContent = logP.toFixed(2);
    Pout.textContent = formatP(Pbar);
    TstartOut.textContent = T0.toFixed(0);
    Qout.textContent = Qnow.toFixed(0);
    TnowOut.textContent = Tnow.toFixed(1);

    let col="#0b8a3b";
    if (ph.startsWith("Solid")) col="#555";
    else if (ph==="Vapour") col="#1e5aa8";
    else if (ph.startsWith("Supercritical")) col="#b22";
    stateOut.style.color = col;
    stateOut.textContent = `${label} (${ph})`;

    TmOut.textContent = Tm.toFixed(1);
    TbOut.textContent = Tb.toFixed(1);

    drawPhaseDiagram(Tnow, Pbar);
    drawHeatingCurve(segs, Qnow, Tnow, Tm, Tb, Math.min(QmaxRounded, Qmax));
  }

  Pslider.addEventListener("input", updateAll);
  Tstart.addEventListener("input", updateAll);
  mass.addEventListener("input", updateAll);
  Qslider.addEventListener("input", updateAll);

  styleButtons();
  document.querySelectorAll("[data-preset]").forEach(b=>{
    b.addEventListener("click",()=>{
      const p=b.getAttribute("data-preset");
      let Pbar=1.0;
      if (p==="sea") Pbar=1.0;
      if (p==="mountain") Pbar=0.7;
      if (p==="pressurecooker") Pbar=15;
      if (p==="deep") Pbar=1e4;
      if (p==="verydeep") Pbar=1e6;
      Pslider.value = log10(Pbar);
      updateAll();
    });
  });

  updateAll();
})();
</script>
